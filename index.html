<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Form Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Modern Animations */
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px) scale(0.95); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        
        .slide-in { animation: slideIn 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideIn { 
            from { opacity: 0; transform: translateX(-30px); } 
            to { opacity: 1; transform: translateX(0); } 
        }
        
                 .pulse-glow { animation: pulseGlow 3s ease-in-out infinite; }
         @keyframes pulseGlow { 
             0%, 100% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); } 
             50% { box-shadow: 0 0 50px rgba(59, 130, 246, 0.8), 0 0 80px rgba(147, 51, 234, 0.4); } 
         }
        
        .float { animation: float 6s ease-in-out infinite; }
        @keyframes float { 
            0%, 100% { transform: translateY(0px); } 
            50% { transform: translateY(-10px); } 
        }
        
        .shimmer { animation: shimmer 2s linear infinite; }
        @keyframes shimmer { 
            0% { background-position: -200% 0; } 
            100% { background-position: 200% 0; } 
        }
        
                 /* Advanced Gradients */
         .gradient-bg { 
             background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #7c3aed 100%);
             background-size: 200% 200%;
             animation: gradientShift 20s ease infinite;
             min-height: 100vh;
             overflow-x: hidden;
             overflow-y: auto;
         }
        @keyframes gradientShift { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }
        
                 .glass { 
             backdrop-filter: blur(20px) saturate(180%);
             background: rgba(255, 255, 255, 0.12);
             border: 1px solid rgba(255, 255, 255, 0.2);
             box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
         }
        
        .glass-dark { 
            backdrop-filter: blur(20px) saturate(180%);
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
                 /* Enhanced Buttons */
         .btn-glow:hover { 
             box-shadow: 0 0 30px rgba(59, 130, 246, 0.6), 0 0 60px rgba(147, 51, 234, 0.3);
             transform: translateY(-3px) scale(1.02);
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
         }
        
        .btn-shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }
        
                 /* Card Effects */
         .card-hover:hover { 
             transform: translateY(-8px) scale(1.02);
             box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15), 0 0 30px rgba(59, 130, 246, 0.2);
             transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
         }
        
                 /* Input Styling */
         .input-glow:focus {
             box-shadow: 0 0 20px rgba(59, 130, 246, 0.4), 0 0 40px rgba(147, 51, 234, 0.2);
             transform: scale(1.02);
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
         }
        
        /* Particle Effect */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            animation: particleFloat 30s linear infinite;
        }
        
        @keyframes particleFloat {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) rotate(180deg); opacity: 0; }
        }
        
        /* Subtle Text Glow */
        .text-glow {
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }
        
        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
                 /* Responsive Design */
         @media (max-width: 768px) {
             .container { padding: 1rem; }
             .text-5xl { font-size: 2.5rem; }
             .text-2xl { font-size: 1.5rem; }
             
             /* Mobile-specific optimizations */
             .glass { 
                 backdrop-filter: blur(15px) saturate(150%);
                 background: rgba(255, 255, 255, 0.15);
                 border: 1px solid rgba(255, 255, 255, 0.25);
             }
             
             /* Larger touch targets */
             button, input, select, textarea {
                 min-height: 44px;
                 font-size: 16px !important; /* Prevents zoom on iOS */
             }
             
                      /* Mobile-friendly spacing */
         .mb-8 { margin-bottom: 1.5rem; }
         .p-8 { padding: 1.5rem; }
         .px-6 { padding-left: 1rem; padding-right: 1rem; }
         .py-4 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
         
         /* Touch-friendly interactions */
         button, input, select, textarea {
             -webkit-tap-highlight-color: transparent;
             touch-action: manipulation;
         }
         
         /* Prevent text selection on buttons */
         button {
             -webkit-user-select: none;
             -moz-user-select: none;
             -ms-user-select: none;
             user-select: none;
         }
             
             /* Stack buttons vertically on mobile */
             .flex.space-x-4 {
                 flex-direction: column;
                 gap: 0.75rem;
             }
             
             /* Mobile modal adjustments */
             .glass-dark {
                 margin: 1rem;
                 padding: 1.5rem;
                 max-width: calc(100vw - 2rem);
             }
         }
         
         /* Extra small devices */
         @media (max-width: 480px) {
             .text-5xl { font-size: 2rem; }
             .text-4xl { font-size: 1.75rem; }
             .text-3xl { font-size: 1.5rem; }
             
             .container { padding: 0.5rem; }
             
             /* Compact mobile layout */
             .p-8 { padding: 1rem; }
             .mb-8 { margin-bottom: 1rem; }
             
             /* Single column grid on very small screens */
             .grid.grid-cols-1.md\\:grid-cols-3 {
                 grid-template-columns: 1fr;
             }
         }
         
         /* Fix scrolling issues */
         body {
             overflow-x: hidden;
             overflow-y: auto;
             scroll-behavior: smooth;
             min-height: 100vh;
             -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
         }
         
         html {
             scroll-behavior: smooth;
             height: 100%;
         }
         
                 /* Dropdown styling */
        select option {
            background-color: #1f2937 !important;
            color: white !important;
            padding: 8px 12px;
        }
        
        select option:hover {
            background-color: #374151 !important;
        }
        
        select option:checked {
            background-color: #3b82f6 !important;
        }
        
        /* Drag and Drop Styles */
        .question-item {
            transition: all 0.2s ease;
        }
        
        .question-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .question-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .drag-handle {
            position: absolute;
            top: 8px;
            right: 40px;
            cursor: grab;
            transition: color 0.2s ease;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .question-item:hover .drag-handle {
            color: #4f46e5;
        }
        
        .cursor-move {
            cursor: move;
        }
    </style>
</head>
 <body class="min-h-screen gradient-bg relative">
    <!-- Particle Background -->
    <div class="particles" id="particles"></div>
    
         <div class="container mx-auto px-4 py-8 max-w-6xl relative z-10">
        <div class="text-center mb-12 fade-in">
            <div class="mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mx-auto flex items-center justify-center shadow-lg mb-4">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
            </div>
            <h1 class="text-5xl font-bold text-white mb-4">Form Builder Pro</h1>
            <p class="text-xl text-white/80 max-w-2xl mx-auto leading-relaxed mb-6">Create professional Google Forms with AI assistance</p>
            <div class="flex justify-center space-x-6">
                <div class="flex items-center space-x-2 text-white/70">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-sm">AI-Powered</span>
                </div>
                <div class="flex items-center space-x-2 text-white/70">
                    <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                    <span class="text-sm">Real-time Preview</span>
                </div>
                <div class="flex items-center space-x-2 text-white/70">
                    <div class="w-2 h-2 bg-purple-400 rounded-full"></div>
                    <span class="text-sm">Instant Creation</span>
                </div>
            </div>
        </div>

        <div id="formContainer" class="flex justify-center">
            <div class="w-full max-w-2xl" id="mainFormSection">
                <div class="glass rounded-3xl p-8 card-hover transition-all duration-300 slide-in">
                <div class="flex items-center mb-8">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-white">Form Configuration</h2>
                </div>
                
                <div class="mb-8">
                    <label class="block text-white font-semibold mb-3 text-lg">🎯 Form Title</label>
                    <input type="text" id="formTitle" placeholder="Enter your form title..." class="w-full px-6 py-4 rounded-2xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-400/50 transition-all input-glow text-lg">
                </div>

                <div class="mb-8">
                    <label class="block text-white font-semibold mb-3 text-lg">❓ Question Text</label>
                    <div class="flex gap-4 mb-4">
                        <input type="text" id="questionText" placeholder="Enter your question..." class="flex-1 px-6 py-4 rounded-2xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-400/50 transition-all input-glow text-lg">
                        <button onclick="showCSVImportModal()" class="px-6 py-4 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-2xl hover:from-green-600 hover:to-teal-700 transition-all btn-glow font-semibold text-lg shadow-lg">📁 Import CSV</button>
                    </div>
                    <div id="csvImportPreview" class="hidden mt-4 p-4 bg-white/10 rounded-2xl border border-white/20">
                        <h4 class="text-white font-semibold mb-2">📋 Imported Questions:</h4>
                        <div id="importedQuestionsList" class="max-h-32 overflow-y-auto space-y-2"></div>
                        <button onclick="importQuestionsFromCSV()" class="mt-4 px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all btn-glow font-semibold">✅ Import All Questions</button>
                    </div>
                </div>

                <div class="mb-8">
                    <label class="block text-white font-semibold mb-3 text-lg">📋 Question Type</label>
                                         <select id="questionType" class="w-full px-6 py-4 rounded-2xl bg-white/10 text-white border border-white/20 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-400/50 transition-all input-glow text-lg">
                         <option value="Short Answer" class="bg-gray-800 text-white">Short Answer</option>
                         <option value="Paragraph" class="bg-gray-800 text-white">Paragraph</option>
                         <option value="Multiple Choice" class="bg-gray-800 text-white">Multiple Choice</option>
                         <option value="Checkboxes" class="bg-gray-800 text-white">Checkboxes</option>
                         <option value="Dropdown" class="bg-gray-800 text-white">Dropdown</option>
                     </select>
                </div>

                <div id="optionsSection" class="mb-8 hidden">
                    <label class="block text-white font-semibold mb-4 text-lg">⚙️ Options Configuration</label>
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="setOptionMethod('manual')" id="manualBtn" class="px-6 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl hover:from-blue-600 hover:to-blue-700 transition-all btn-glow font-semibold text-lg shadow-lg">✏️ Manual</button>
                            <button onclick="setOptionMethod('csv')" id="csvBtn" class="px-6 py-4 bg-white/20 text-white rounded-2xl hover:bg-white/30 transition-all font-semibold text-lg shadow-lg">📁 Upload CSV</button>
                            <button onclick="setOptionMethod('ai')" id="aiBtn" class="px-6 py-4 bg-white/20 text-white rounded-2xl hover:bg-white/30 transition-all font-semibold text-lg shadow-lg">🤖 AI Generate</button>
                        </div>
                        
                        <div id="manualOptions">
                            <textarea id="optionsText" placeholder="Option 1&#10;Option 2&#10;Option 3" class="w-full px-6 py-4 rounded-2xl bg-white/10 text-white placeholder-white/60 border border-white/20 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-400/50 transition-all h-40 text-lg input-glow resize-none"></textarea>
                        </div>
                        
                        <div id="csvOptions" class="hidden">
                            <div class="border-2 border-dashed border-white/30 rounded-2xl p-8 text-center hover:border-white/50 transition-all relative">
                                <input type="file" id="csvFile" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" style="pointer-events: auto;">
                                <div class="text-white/80 relative z-0" style="pointer-events: none;">
                                    <svg class="w-12 h-12 mx-auto mb-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-lg font-semibold">Drop your CSV file here</p>
                                    <p class="text-sm opacity-75">or click to browse</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="aiOptions" class="hidden">
                                                     <div class="flex flex-col sm:flex-row gap-4">
                             <input type="number" id="numOptions" value="4" min="2" max="10" class="flex-1 px-6 py-4 rounded-2xl bg-white/10 text-white border border-white/20 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-400/50 transition-all text-lg input-glow">
                             <button onclick="generateAIOptions()" class="px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl hover:from-purple-600 hover:to-pink-600 transition-all btn-glow font-semibold text-lg shadow-lg">🚀 Generate</button>
                         </div>
                            <div id="aiOptionsResult" class="mt-4 hidden"></div>
                        </div>
                    </div>
                </div>

                <div id="paragraphSection" class="mb-8 hidden">
                    <label class="block text-white font-semibold mb-4 text-lg">💡 AI Example Answers</label>
                                             <div class="flex flex-col sm:flex-row gap-4">
                             <input type="number" id="numExamples" value="3" min="1" max="10" class="flex-1 px-6 py-4 rounded-2xl bg-white/10 text-white border border-white/20 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-400/50 transition-all text-lg input-glow">
                             <button onclick="generateAIExamples()" class="px-8 py-4 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-2xl hover:from-green-600 hover:to-blue-600 transition-all btn-glow font-semibold text-lg shadow-lg">✨ Generate Examples</button>
                         </div>
                    <div id="aiExamplesResult" class="mt-4 hidden"></div>
                </div>

                                <div class="mb-8">
                    <button onclick="showAIGenerationModal()" class="w-full px-8 py-6 bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 text-white rounded-2xl hover:from-purple-600 hover:via-pink-600 hover:to-red-600 transition-all btn-glow font-bold text-xl shadow-2xl mb-6 btn-shimmer">🤖 Generate Questions with AI</button>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <button onclick="addQuestion()" class="flex-1 px-8 py-6 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl hover:from-blue-600 hover:to-purple-700 transition-all btn-glow font-bold text-lg shadow-lg">➕ Add Question</button>
                    <button onclick="clearForm()" class="px-8 py-6 bg-white/20 text-white rounded-2xl hover:bg-white/30 transition-all font-bold text-lg shadow-lg">🗑️ Clear</button>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="shuffleQuestions()" class="flex-1 px-6 py-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-2xl hover:from-yellow-600 hover:to-orange-600 transition-all btn-glow font-semibold text-lg shadow-lg">
                        <i class="fas fa-random mr-2"></i>Reorder Questions
                    </button>
                    <button onclick="generateSemanticResponses()" class="flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-2xl hover:from-green-600 hover:to-teal-600 transition-all btn-glow font-semibold text-lg shadow-lg">
                        <i class="fas fa-users mr-2"></i>Test Responses
                    </button>
                </div>
            </div>
        </div>

        <div id="formPreviewSection" class="glass rounded-3xl p-8 card-hover transition-all duration-300 slide-in hidden">
            <div class="flex items-center mb-8">
                <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-teal-600 rounded-xl flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-white">Questions List</h2>
            </div>
            
            <div id="questionsPreview" class="space-y-4 mb-8">
                <div class="text-white/70 text-center py-12">
                    <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <p class="text-lg font-semibold">No questions added yet</p>
                    <p class="text-sm opacity-75">Add your first question to see the list!</p>
                </div>
            </div>
            
            <div id="createFormSection" class="hidden">
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <button onclick="showAIGenerationModal()" class="flex-1 px-6 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl hover:from-purple-600 hover:to-pink-600 transition-all btn-glow font-bold text-lg shadow-lg">🤖 Add More Questions</button>
                    <button onclick="createGoogleForm()" id="createFormBtn" class="flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-2xl hover:from-green-600 hover:to-teal-700 transition-all btn-glow font-bold text-lg pulse-glow shadow-2xl">🚀 Create Google Form</button>
                </div>
            </div>
        </div>

        <div id="loadingModal" class="fixed inset-0 bg-black/60 backdrop-blur-md hidden items-center justify-center z-50">
            <div class="glass-dark rounded-3xl p-12 max-w-md mx-4">
                <div class="text-center">
                    <div class="spinner mx-auto mb-6"></div>
                    <h3 class="text-2xl font-bold text-white mb-4 text-glow">Creating Your Form...</h3>
                    <p class="text-white/80 text-lg">Please wait while we generate your Google Form</p>
                    <div class="mt-6 flex justify-center space-x-2">
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-pink-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            </div>
        </div>

                 <div id="successModal" class="fixed inset-0 bg-black/60 backdrop-blur-md hidden items-center justify-center z-50">
             <div class="glass-dark rounded-3xl p-12 max-w-md mx-4">
                 <div class="text-center">
                     <div class="w-20 h-20 bg-gradient-to-r from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl">
                         <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                         </svg>
                     </div>
                     <h3 class="text-3xl font-bold text-white mb-6 text-glow">Form Created Successfully!</h3>
                     <a id="formLink" href="#" target="_blank" class="inline-block px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl hover:from-blue-600 hover:to-purple-700 transition-all btn-glow mb-6 font-bold text-xl shadow-lg">🎉 View Your Form</a>
                     <div>
                         <button onclick="closeSuccessModal()" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30 transition-all font-semibold">Close</button>
                     </div>
                 </div>
             </div>
         </div>

         <!-- Welcome Popup -->
         <div id="welcomeModal" class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 p-4">
             <div class="glass-dark rounded-3xl p-6 sm:p-8 md:p-12 max-w-2xl w-full mx-auto max-h-[90vh] overflow-y-auto">
                 <div class="text-center">
                     <div class="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6 md:mb-8 shadow-2xl">
                         <svg class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                         </svg>
                     </div>
                     <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-4 sm:mb-6 text-glow">Welcome to Form Builder Pro!</h2>
                     <p class="text-base sm:text-lg md:text-xl text-white/90 mb-6 sm:mb-8 leading-relaxed">The hassle-free Google Form creator powered by AI</p>
                     
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
                         <div class="bg-white/10 rounded-2xl p-4 sm:p-6 border border-white/20">
                             <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 sm:mb-4">
                                 <span class="text-white font-bold text-base sm:text-lg">1</span>
                             </div>
                             <h3 class="text-white font-bold text-base sm:text-lg mb-2">Input Heading</h3>
                             <p class="text-white/80 text-xs sm:text-sm">Just enter your form title and let AI do the work</p>
                         </div>
                         <div class="bg-white/10 rounded-2xl p-4 sm:p-6 border border-white/20">
                             <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-3 sm:mb-4">
                                 <span class="text-white font-bold text-base sm:text-lg">2</span>
                             </div>
                             <h3 class="text-white font-bold text-base sm:text-lg mb-2">AI Generates</h3>
                             <p class="text-white/80 text-xs sm:text-sm">AI creates relevant questions with smart options</p>
                         </div>
                         <div class="bg-white/10 rounded-2xl p-4 sm:p-6 border border-white/20">
                             <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-3 sm:mb-4">
                                 <span class="text-white font-bold text-base sm:text-lg">3</span>
                             </div>
                             <h3 class="text-white font-bold text-base sm:text-lg mb-2">Review & Create</h3>
                             <p class="text-white/80 text-xs sm:text-sm">Review, edit if needed, and create instantly</p>
                         </div>
                     </div>
                     
                     <div class="bg-purple-500/20 border border-purple-500/30 rounded-2xl p-3 sm:p-4 mb-4 sm:mb-6">
                         <div class="flex items-start space-x-2 sm:space-x-3">
                             <div class="w-5 h-5 sm:w-6 sm:h-6 bg-purple-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                 <i class="fas fa-magic text-white text-xs sm:text-sm"></i>
                             </div>
                             <div>
                                 <h4 class="text-purple-300 font-semibold text-xs sm:text-sm mb-1">✨ New Features</h4>
                                 <p class="text-purple-200/90 text-xs sm:text-sm">• Drag & drop to reorder questions • Shuffle questions randomly • Generate Semantic test responses • Download responses as CSV/JSON</p>
                             </div>
                         </div>
                     </div>
                     
                     <div class="bg-yellow-500/20 border border-yellow-500/30 rounded-2xl p-3 sm:p-4 mb-4 sm:mb-6">
                         <div class="flex items-start space-x-2 sm:space-x-3">
                             <div class="w-5 h-5 sm:w-6 sm:h-6 bg-yellow-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                 <svg class="w-3 h-3 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                 </svg>
                             </div>
                             <div>
                                 <h4 class="text-yellow-300 font-semibold text-xs sm:text-sm mb-1">💡 Pro Tip</h4>
                                 <p class="text-yellow-200/90 text-xs sm:text-sm">If you encounter any errors or bugs, simply try again without reloading the page. The AI will generate fresh content each time!</p>
                             </div>
                         </div>
                     </div>
                     
                     <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
                         <button onclick="closeWelcomeModal()" class="px-6 sm:px-8 py-3 sm:py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl hover:from-blue-600 hover:to-purple-700 transition-all btn-glow font-bold text-base sm:text-lg shadow-lg">🚀 Get Started</button>
                         <button onclick="showTutorial()" class="px-6 sm:px-8 py-3 sm:py-4 bg-white/20 text-white rounded-2xl hover:bg-white/30 transition-all font-bold text-base sm:text-lg">📖 How It Works</button>
                     </div>
                 </div>
             </div>
         </div>

         <!-- Sentiment Configuration Modal -->
         <div id="sentimentModal" class="fixed inset-0 bg-black/60 backdrop-blur-md hidden items-center justify-center z-50 p-4">
             <div class="glass-dark rounded-3xl p-8 max-w-md w-full mx-4">
                 <div class="flex justify-between items-center mb-6">
                     <h3 class="text-2xl font-bold text-white">Response Tone Configuration</h3>
                     <button id="closeSentimentModal" class="text-white/60 hover:text-white">
                         <i class="fas fa-times text-xl"></i>
                     </button>
                 </div>
                 
                 <p class="text-white/80 mb-6">Adjust the emotional balance of your Semantic responses to match your desired tone.</p>
                 
                 <div class="space-y-6">
                     <div>
                         <label class="block text-white font-semibold mb-3">Positive Responses (%)</label>
                         <input type="range" id="positivePercent" min="0" max="100" value="70" class="w-full">
                         <div class="flex justify-between text-white/60 text-sm mt-1">
                             <span>0%</span>
                             <span id="positiveValue">70%</span>
                             <span>100%</span>
                         </div>
                     </div>
                     
                     <div>
                         <label class="block text-white font-semibold mb-3">Neutral Responses (%)</label>
                         <input type="range" id="neutralPercent" min="0" max="100" value="20" class="w-full">
                         <div class="flex justify-between text-white/60 text-sm mt-1">
                             <span>0%</span>
                             <span id="neutralValue">20%</span>
                             <span>100%</span>
                         </div>
                     </div>
                     
                     <div>
                         <label class="block text-white font-semibold mb-3">Negative Responses (%)</label>
                         <input type="range" id="negativePercent" min="0" max="100" value="10" class="w-full">
                         <div class="flex justify-between text-white/60 text-sm mt-1">
                             <span>0%</span>
                             <span id="negativeValue">10%</span>
                             <span>100%</span>
                         </div>
                     </div>
                     
                     <div class="bg-white/10 rounded-xl p-4 border border-white/20">
                         <div class="flex items-center">
                             <i class="fas fa-info-circle text-blue-400 mr-3"></i>
                             <span class="text-white/90">Total: <span id="totalPercent">100%</span></span>
                         </div>
                     </div>
                     
                     <div>
                         <label class="block text-white font-semibold mb-3">Question Type Filter</label>
                         <select id="questionTypeFilter" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-blue-400">
                             <option value="">All Question Types</option>
                             <option value="Short Answer">Short Answer Only</option>
                             <option value="Paragraph">Paragraph Only</option>
                             <option value="Multiple Choice">Multiple Choice Only</option>
                             <option value="Checkboxes">Checkboxes Only</option>
                             <option value="Dropdown">Dropdown Only</option>
                         </select>
                         <p class="text-white/60 text-sm mt-1">Select to generate responses for specific question types only</p>
                     </div>
                 </div>
                 
                 <div class="flex gap-4 mt-8">
                     <button id="generateSemanticResponses" class="flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-2xl hover:from-green-600 hover:to-teal-700 transition-all btn-glow font-semibold">
                         <i class="fas fa-magic mr-2"></i>Test Responses
                     </button>
                     <button id="cancelSentimentModal" class="flex-1 px-6 py-4 bg-white/20 text-white rounded-2xl hover:bg-white/30 transition-all font-semibold">
                         Cancel
                     </button>
                 </div>
             </div>
         </div>

         <!-- Sentiment Configuration Popup -->
         <div id="sentimentConfigPopup" class="fixed inset-0 bg-black/60 backdrop-blur-md hidden items-center justify-center z-50 p-4">
             <div class="glass-dark rounded-3xl p-8 max-w-md w-full mx-4">
                 <div class="text-center mb-6">
                     <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-600 rounded-full flex items-center justify-center mx-auto mb-4">
                         <i class="fas fa-sliders-h text-white text-2xl"></i>
                     </div>
                     <h3 class="text-2xl font-bold text-white mb-2">Response Tone Settings</h3>
                     <p class="text-white/80">Choose how you want to balance the emotional tone of generated responses</p>
                 </div>
                 
                 <div class="space-y-4 mb-6">
                     <button onclick="useDefaultSentiment()" class="w-full px-6 py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl hover:from-blue-600 hover:to-purple-700 transition-all btn-glow font-semibold">
                         <i class="fas fa-magic mr-2"></i>Use Default (70% Positive, 20% Neutral, 10% Negative)
                     </button>
                     <button onclick="useManualSentiment()" class="w-full px-6 py-4 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-2xl hover:from-green-600 hover:to-teal-700 transition-all btn-glow font-semibold">
                         <i class="fas fa-sliders-h mr-2"></i>Configure Manually
                     </button>
                 </div>
                 
                 <div class="text-center">
                     <button onclick="hideSentimentConfigPopup()" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30 transition-all font-semibold">
                         Cancel
                     </button>
                 </div>
             </div>
         </div>

         <!-- Semantic Responses Results -->
         <div id="responsesResults" class="fixed inset-0 bg-black/60 backdrop-blur-md hidden items-center justify-center z-50 p-4">
             <div class="glass-dark rounded-3xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                 <div class="flex justify-between items-center mb-6">
                     <h3 class="text-2xl font-bold text-white">Semantic Responses Generated</h3>
                     <button id="closeResponsesResults" onclick="hideResponsesResults()" class="text-white/60 hover:text-white">
                         <i class="fas fa-times text-xl"></i>
                     </button>
                 </div>
                 
                 <div class="bg-green-500/20 border border-green-400/30 rounded-xl p-4 mb-6">
                     <div class="flex items-center">
                         <i class="fas fa-check-circle text-green-400 text-xl mr-3"></i>
                         <div>
                             <p class="text-green-300 font-semibold">Responses generated successfully!</p>
                             <p class="text-green-300/80 text-sm">Preview the responses below or download them as files.</p>
                         </div>
                     </div>
                 </div>
                 
                 <!-- Preview Section -->
                 <div id="responsesPreviewSection" class="mb-6">
                     <h4 class="text-white font-semibold text-lg mb-4">📊 Responses Preview</h4>
                     <div id="responsesPreviewTable" class="bg-white/10 rounded-xl p-4 overflow-x-auto">
                         <!-- Preview table will be added here -->
                     </div>
                 </div>
                 
                 <div id="responsesDownloadSection" class="space-y-4">
                     <!-- Download buttons will be added here -->
                 </div>
             </div>
         </div>

         <!-- AI Generation Modal -->
         <div id="aiGenerationModal" class="fixed inset-0 bg-black/60 backdrop-blur-md hidden items-center justify-center z-50 p-4">
             <div class="glass-dark rounded-3xl p-6 sm:p-8 md:p-12 max-w-2xl w-full mx-auto max-h-[90vh] overflow-y-auto">
                 <div class="text-center mb-6">
                     <div class="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 bg-gradient-to-r from-purple-500 to-pink-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-2xl">
                         <svg class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                         </svg>
                     </div>
                     <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-4 text-glow">AI Form Generation</h2>
                     <p class="text-base sm:text-lg md:text-xl text-white/90 mb-6">Customize your AI-generated form</p>
                 </div>

                 <!-- Step 1: Question Count -->
                 <div id="step1" class="mb-6">
                     <h3 class="text-white font-bold text-lg sm:text-xl mb-4">📊 How many questions do you need?</h3>
                     <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                         <button onclick="selectQuestionCount(3)" class="question-count-btn px-4 py-3 bg-white/10 text-white rounded-xl hover:bg-white/20 transition-all border border-white/20">3</button>
                         <button onclick="selectQuestionCount(5)" class="question-count-btn px-4 py-3 bg-white/10 text-white rounded-xl hover:bg-white/20 transition-all border border-white/20">5</button>
                         <button onclick="selectQuestionCount(8)" class="question-count-btn px-4 py-3 bg-white/10 text-white rounded-xl hover:bg-white/20 transition-all border border-white/20">8</button>
                         <button onclick="selectQuestionCount(10)" class="question-count-btn px-4 py-3 bg-white/10 text-white rounded-xl hover:bg-white/20 transition-all border border-white/20">10</button>
                     </div>
                     <div class="flex items-center gap-4">
                         <label class="text-white font-medium">Custom:</label>
                         <input type="number" id="customQuestionCount" min="1" max="20" value="5" class="flex-1 px-4 py-2 rounded-xl bg-white/10 text-white border border-white/20 focus:border-purple-400 focus:outline-none">
                     </div>
                 </div>

                 <!-- Step 2: Question Types -->
                 <div id="step2" class="mb-6 hidden">
                     <h3 class="text-white font-bold text-lg sm:text-xl mb-4">📋 Select question types (you can choose multiple)</h3>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                         <label class="flex items-center p-3 bg-white/10 rounded-xl border border-white/20 hover:bg-white/20 transition-all cursor-pointer">
                             <input type="checkbox" id="shortAnswer" class="mr-3" checked>
                             <span class="text-white font-medium">Short Answer</span>
                         </label>
                         <label class="flex items-center p-3 bg-white/10 rounded-xl border border-white/20 hover:bg-white/20 transition-all cursor-pointer">
                             <input type="checkbox" id="paragraph" class="mr-3" checked>
                             <span class="text-white font-medium">Paragraph</span>
                         </label>
                         <label class="flex items-center p-3 bg-white/10 rounded-xl border border-white/20 hover:bg-white/20 transition-all cursor-pointer">
                             <input type="checkbox" id="multipleChoice" class="mr-3" checked>
                             <span class="text-white font-medium">Multiple Choice</span>
                         </label>
                         <label class="flex items-center p-3 bg-white/10 rounded-xl border border-white/20 hover:bg-white/20 transition-all cursor-pointer">
                             <input type="checkbox" id="checkboxes" class="mr-3" checked>
                             <span class="text-white font-medium">Checkboxes</span>
                         </label>
                         <label class="flex items-center p-3 bg-white/10 rounded-xl border border-white/20 hover:bg-white/20 transition-all cursor-pointer">
                             <input type="checkbox" id="dropdown" class="mr-3" checked>
                             <span class="text-white font-medium">Dropdown</span>
                         </label>
                     </div>
                     <div class="bg-blue-500/20 border border-blue-500/30 rounded-xl p-3 mb-4">
                         <p class="text-blue-200 text-sm">💡 You can select multiple types. AI will distribute questions across selected types.</p>
                     </div>
                 </div>

                 <!-- Step 3: Semantic Responses (Optional) -->
                 <div id="step3" class="mb-6 hidden">
                     <h3 class="text-white font-bold text-lg sm:text-xl mb-4">🎭 Generate Semantic Responses (Optional)</h3>
                     <p class="text-white/80 mb-4">Create realistic test data for your form with configurable sentiment distribution.</p>
                     
                     <div class="bg-white/10 rounded-xl p-4 border border-white/20 mb-4">
                         <label class="flex items-center cursor-pointer">
                             <input type="checkbox" id="generateSemanticData" class="mr-3">
                             <span class="text-white font-medium">Generate Semantic responses for testing</span>
                         </label>
                     </div>
                     
                     <div id="SemanticOptions" class="hidden space-y-4">
                         <div>
                             <label class="block text-white font-semibold mb-2">Number of Responses:</label>
                             <input type="number" id="SemanticResponseCount" min="1" max="20" value="5" class="w-full px-4 py-2 rounded-xl bg-white/10 text-white border border-white/20 focus:border-purple-400 focus:outline-none">
                         </div>
                         
                         <div>
                             <label class="block text-white font-semibold mb-2">Positive Responses (%)</label>
                             <input type="range" id="aiPositivePercent" min="0" max="100" value="70" class="w-full">
                             <div class="flex justify-between text-white/60 text-sm mt-1">
                                 <span>0%</span>
                                 <span id="aiPositiveValue">70%</span>
                                 <span>100%</span>
                             </div>
                         </div>
                         
                         <div>
                             <label class="block text-white font-semibold mb-2">Neutral Responses (%)</label>
                             <input type="range" id="aiNeutralPercent" min="0" max="100" value="20" class="w-full">
                             <div class="flex justify-between text-white/60 text-sm mt-1">
                                 <span>0%</span>
                                 <span id="aiNeutralValue">20%</span>
                                 <span>100%</span>
                             </div>
                         </div>
                         
                         <div>
                             <label class="block text-white font-semibold mb-2">Negative Responses (%)</label>
                             <input type="range" id="aiNegativePercent" min="0" max="100" value="10" class="w-full">
                             <div class="flex justify-between text-white/60 text-sm mt-1">
                                 <span>0%</span>
                                 <span id="aiNegativeValue">10%</span>
                                 <span>100%</span>
                             </div>
                         </div>
                         
                         <div class="bg-blue-500/20 border border-blue-500/30 rounded-xl p-3">
                             <div class="flex items-center">
                                 <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                                 <span class="text-blue-200">Total: <span id="aiTotalPercent">100%</span></span>
                             </div>
                         </div>
                     </div>
                 </div>

                 <!-- Step 4: Generation Summary -->
                 <div id="step4" class="mb-6 hidden">
                     <h3 class="text-white font-bold text-lg sm:text-xl mb-4">🎯 Generation Summary</h3>
                     <div class="bg-white/10 rounded-xl p-4 border border-white/20">
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                 <h4 class="text-white font-semibold mb-2">📊 Questions:</h4>
                                 <p class="text-white/80">Total: <span id="summaryQuestionCount" class="font-bold">5</span></p>
                                 <p class="text-white/80">Types: <span id="summaryQuestionTypes" class="font-bold">Short Answer, Paragraph, Multiple Choice, Checkboxes, Dropdown</span></p>
                             </div>
                             <div>
                                 <h4 class="text-white font-semibold mb-2">🤖 AI Generation:</h4>
                                 <p class="text-white/80">Form Title: <span id="summaryFormTitle" class="font-bold">Your Form Title</span></p>
                                 <p class="text-white/80">Smart distribution across selected types</p>
                                 <p class="text-white/80" id="SemanticSummary" style="display: none;">Semantic Responses: <span id="SemanticResponseSummary" class="font-bold">5 responses</span></p>
                             </div>
                         </div>
                     </div>
                 </div>

                 <!-- Navigation Buttons -->
                 <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
                     <button onclick="closeAIGenerationModal()" class="px-6 sm:px-8 py-3 sm:py-4 bg-white/20 text-white rounded-2xl hover:bg-white/30 transition-all font-bold text-base sm:text-lg">❌ Cancel</button>
                     <button onclick="previousStep()" id="prevBtn" class="px-6 sm:px-8 py-3 sm:py-4 bg-gray-500 text-white rounded-2xl hover:bg-gray-600 transition-all font-bold text-base sm:text-lg hidden">⬅️ Previous</button>
                     <button onclick="nextStep()" id="nextBtn" class="px-6 sm:px-8 py-3 sm:py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl hover:from-purple-600 hover:to-pink-600 transition-all btn-glow font-bold text-base sm:text-lg">Next ➡️</button>
                     <button onclick="generateFormWithAI()" id="generateBtn" class="px-6 sm:px-8 py-3 sm:py-4 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-2xl hover:from-green-600 hover:to-blue-600 transition-all btn-glow font-bold text-base sm:text-lg hidden">🚀 Generate Form</button>
                 </div>
             </div>
         </div>

         <!-- CSV Import Modal -->
         <div id="csvImportModal" class="fixed inset-0 bg-black/60 backdrop-blur-md hidden items-center justify-center z-50 p-4">
             <div class="glass-dark rounded-3xl p-6 sm:p-8 md:p-12 max-w-2xl w-full mx-auto max-h-[90vh] overflow-y-auto">
                 <div class="text-center mb-6">
                     <div class="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 bg-gradient-to-r from-green-500 to-teal-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-2xl">
                         <svg class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                         </svg>
                     </div>
                     <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-4 text-glow">Import Questions from CSV</h2>
                     <p class="text-base sm:text-lg md:text-xl text-white/90 mb-6">Upload a CSV file with your questions</p>
                 </div>

                 <div class="mb-6">
                     <div class="border-2 border-dashed border-white/30 rounded-xl p-8 text-center hover:border-white/50 transition-all relative">
                         <input type="file" id="csvImportFile" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                         <div class="text-white/80 relative z-0">
                             <svg class="w-16 h-16 mx-auto mb-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                             </svg>
                             <p class="text-xl font-semibold">Drop your CSV file here</p>
                             <p class="text-sm opacity-75 mb-2">or click to browse</p>
                             <div class="bg-white/10 rounded-lg p-3 mt-4">
                                 <p class="text-sm font-medium">📋 CSV Format:</p>
                                 <p class="text-xs opacity-75">Column 1: Question text</p>
                                 <p class="text-xs opacity-75">Column 2: Question type (optional)</p>
                                 <p class="text-xs opacity-75">Column 3+: Options (optional, comma-separated)</p>
                                 <p class="text-xs opacity-75">Example: "What is your favorite color?", "Multiple Choice", "Red, Blue, Green, Yellow"</p>
                             </div>
                         </div>
                     </div>
                 </div>

                 <div id="csvImportPreview" class="mb-6 hidden">
                     <h3 class="text-white font-bold text-lg mb-4">📋 Preview:</h3>
                     <div id="csvImportQuestionsList" class="bg-white/10 rounded-xl p-4 max-h-48 overflow-y-auto space-y-2"></div>
                     <div class="mt-4 text-center">
                         <p class="text-white/80 text-sm">Found <span id="csvQuestionCount" class="font-bold">0</span> questions</p>
                     </div>
                 </div>

                 <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
                     <button onclick="closeCSVImportModal()" class="px-6 sm:px-8 py-3 sm:py-4 bg-white/20 text-white rounded-2xl hover:bg-white/30 transition-all font-bold text-base sm:text-lg">❌ Cancel</button>
                     <button onclick="processCSVImport()" id="processCSVBtn" class="px-6 sm:px-8 py-3 sm:py-4 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-2xl hover:from-green-600 hover:to-teal-700 transition-all btn-glow font-bold text-base sm:text-lg hidden">📥 Import Questions</button>
                 </div>
             </div>
         </div>
    </div>

    <script>
        // Replace with your Google Apps Script Web App URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby56SEBLDNZ6tuZGNNYdQKPVKEwAUf9nEoEeRFUuO_xnnHIP-axbNqWuID2EF0BAFqw_g/exec';
        
        // Load API key from env file
        let GEMINI_API_KEY = 'AIzaSyBWvOxGMQhotE9xibPay49Bm2SnTkrmd0U'; // Default fallback
        const GEMINI_MODEL = 'gemini-2.5-pro';
        
        // Load API key from env file
        async function loadAPIKey() {
            try {
                const response = await fetch('env');
                if (response.ok) {
                    const envContent = await response.text();
                    const apiKeyMatch = envContent.match(/GEMINI_API_KEY=([^\s]+)/);
                    if (apiKeyMatch) {
                        GEMINI_API_KEY = apiKeyMatch[1];
                    }
                }
            } catch (error) {
                console.warn('Could not load API key from env file, using default:', error);
            }
        }
        
        // Initialize API key loading
        loadAPIKey();
        
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

        let questions = [];
        let currentOptionMethod = 'manual';
        let aiGenerationStep = 1;
        let selectedQuestionCount = 5;
        let selectedQuestionTypes = ['Short Answer', 'Paragraph', 'Multiple Choice', 'Checkboxes', 'Dropdown'];
        let csvQuestions = [];
        let importedQuestions = [];
        let questionCounter = 0;

        document.getElementById('questionType').addEventListener('change', function() {
            const type = this.value;
            const optionsSection = document.getElementById('optionsSection');
            const paragraphSection = document.getElementById('paragraphSection');
            
            if (['Multiple Choice', 'Checkboxes', 'Dropdown'].includes(type)) {
                optionsSection.classList.remove('hidden');
                paragraphSection.classList.add('hidden');
            } else if (type === 'Paragraph') {
                optionsSection.classList.add('hidden');
                paragraphSection.classList.remove('hidden');
            } else {
                optionsSection.classList.add('hidden');
                paragraphSection.classList.add('hidden');
            }
        });

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csv = e.target.result;
                    const options = parseCSV(csv);
                    document.getElementById('optionsText').value = options.join('\n');
                };
                reader.readAsText(file);
            }
        });



        function setOptionMethod(method) {
            currentOptionMethod = method;
            document.getElementById('manualBtn').className = method === 'manual' ? 'flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all btn-glow' : 'flex-1 px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all';
            document.getElementById('csvBtn').className = method === 'csv' ? 'flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all btn-glow' : 'flex-1 px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all';
            document.getElementById('aiBtn').className = method === 'ai' ? 'flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all btn-glow' : 'flex-1 px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all';
            
            document.getElementById('manualOptions').classList.toggle('hidden', method !== 'manual');
            document.getElementById('csvOptions').classList.toggle('hidden', method !== 'csv');
            document.getElementById('aiOptions').classList.toggle('hidden', method !== 'ai');
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            return lines.map(line => {
                const firstComma = line.indexOf(',');
                return firstComma > -1 ? line.substring(0, firstComma).trim() : line.trim();
            }).filter(option => option);
        }

        async function callGeminiAPI(prompt) {
            try {
                // Use the current API key (which may have been updated from env file)
                const currentGEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(currentGEMINI_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error(`API Error: ${response.status}`);
                }
            } catch (error) {
                console.error('Gemini API Error:', error);
                return 'Error generating content';
            }
        }

        async function generateAIOptions() {
            const questionText = document.getElementById('questionText').value;
            const questionType = document.getElementById('questionType').value;
            const numOptions = document.getElementById('numOptions').value;
            
            if (!questionText.trim()) {
                alert('Please enter question text first');
                return;
            }

            const resultDiv = document.getElementById('aiOptionsResult');
            resultDiv.className = 'mt-3 p-3 bg-white/10 rounded-lg';
            resultDiv.innerHTML = '<div class="text-white">Generating options...</div>';

            const prompt = `Generate ${numOptions} appropriate options for this ${questionType.toLowerCase()} question: "${questionText}"\n\nReturn only the options, one per line, without numbers or bullet points. Make them realistic and relevant to the question.`;
            
            const response = await callGeminiAPI(prompt);
            const options = response.split('\n').filter(line => line.trim()).slice(0, numOptions);
            
            document.getElementById('optionsText').value = options.join('\n');
            resultDiv.innerHTML = `<div class="text-green-400 font-medium">✓ Generated ${options.length} options</div><div class="text-white/80 text-sm mt-1">${options.join(', ')}</div>`;
        }

        async function generateAIExamples() {
            const questionText = document.getElementById('questionText').value;
            const numExamples = document.getElementById('numExamples').value;
            
            if (!questionText.trim()) {
                alert('Please enter question text first');
                return;
            }

            const resultDiv = document.getElementById('aiExamplesResult');
            resultDiv.className = 'mt-3 p-3 bg-white/10 rounded-lg';
            resultDiv.innerHTML = '<div class="text-white">Generating examples...</div>';

            const prompt = `Generate ${numExamples} realistic example answers for this paragraph question: "${questionText}"\n\nEach example should be 1-3 sentences long and show different ways someone might respond. Return each example on a separate line.`;
            
            const response = await callGeminiAPI(prompt);
            const examples = response.split('\n').filter(line => line.trim()).slice(0, numExamples);
            
            resultDiv.innerHTML = `<div class="text-green-400 font-medium">✓ Generated ${examples.length} examples</div><div class="text-white/80 text-sm mt-2 space-y-1">${examples.map((ex, i) => `<div><strong>Example ${i+1}:</strong> ${ex}</div>`).join('')}</div>`;
        }

        function addQuestion() {
            const text = document.getElementById('questionText').value.trim();
            const type = document.getElementById('questionType').value;
            
            if (!text) {
                alert('Please enter question text');
                return;
            }

            let options = [];
            if (['Multiple Choice', 'Checkboxes', 'Dropdown'].includes(type)) {
                const optionsText = document.getElementById('optionsText').value.trim();
                if (!optionsText) {
                    alert('Please provide options for choice questions');
                    return;
                }
                options = optionsText.split('\n').map(opt => opt.trim()).filter(opt => opt);
            }

            const question = { text, type, options };
            questions.push(question);
            
            // Show the preview section when first question is added
            if (questions.length === 1) {
                // Change layout to side-by-side
                const formContainer = document.getElementById('formContainer');
                formContainer.className = 'grid grid-cols-1 lg:grid-cols-2 gap-8';
                
                // Adjust main form section to be on the left
                const mainFormSection = document.getElementById('mainFormSection');
                mainFormSection.className = 'w-full';
                
                document.getElementById('formPreviewSection').classList.remove('hidden');
                document.getElementById('createFormSection').classList.remove('hidden');
            }
            
            updatePreview();
            clearQuestionForm();
            
            document.getElementById('createFormSection').classList.remove('hidden');
        }

        function removeQuestion(index) {
            questions.splice(index, 1);
            updatePreview();
            if (questions.length === 0) {
                document.getElementById('formPreviewSection').classList.add('hidden');
                document.getElementById('createFormSection').classList.add('hidden');
                // Return to centered layout
                const formContainer = document.getElementById('formContainer');
                formContainer.className = 'flex justify-center';
                // Reset main form section
                const mainFormSection = document.getElementById('mainFormSection');
                mainFormSection.className = 'w-full max-w-2xl';
            }
        }

        function updatePreview() {
            const preview = document.getElementById('questionsPreview');
            
            if (questions.length === 0) {
                preview.innerHTML = `
                    <div class="text-white/70 text-center py-12">
                        <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <p class="text-lg font-semibold">No questions added yet</p>
                        <p class="text-sm opacity-75">Add your first question to see the list!</p>
                    </div>
                `;
                return;
            }

            // Simple list of questions with drag functionality
            const questionsHTML = questions.map((q, index) => `
                <div class="question-item bg-white/10 rounded-xl p-4 border border-white/10 hover:border-white/20 transition-all mb-4 relative" draggable="true">
                    <div class="drag-handle absolute top-3 right-12 text-white/60 hover:text-white/80 cursor-move">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <div class="w-6 h-6 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                                    <span class="question-number text-white font-bold text-xs">${index + 1}</span>
                                </div>
                                <h4 class="text-white font-semibold text-base">${q.text}</h4>
                            </div>
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="px-2 py-1 bg-white/20 text-white rounded-full text-xs font-medium">${q.type}</span>
                                ${q.options.length > 0 ? `<span class="text-white/60 text-xs">${q.options.length} options</span>` : ''}
                            </div>
                            ${q.options.length > 0 ? `
                                <div class="bg-white/5 rounded-lg p-3">
                                    <p class="text-white/70 text-xs font-medium mb-2">Options:</p>
                                    <div class="flex flex-wrap gap-1">
                                        ${q.options.map(option => `<span class="px-2 py-1 bg-white/10 text-white rounded text-xs">${option}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="removeQuestion(${index})" class="text-red-400 hover:text-red-300 transition-colors ml-2 p-1 hover:bg-red-500/20 rounded-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');

            preview.innerHTML = questionsHTML;
        }

        function clearQuestionForm() {
            document.getElementById('questionText').value = '';
            document.getElementById('optionsText').value = '';
            document.getElementById('csvFile').value = '';
            document.getElementById('aiOptionsResult').innerHTML = '';
            document.getElementById('aiExamplesResult').innerHTML = '';
            document.getElementById('questionType').value = 'Short Answer';
            document.getElementById('optionsSection').classList.add('hidden');
            document.getElementById('paragraphSection').classList.add('hidden');
        }



        function clearForm() {
            clearQuestionForm();
            document.getElementById('formTitle').value = '';
            questions = [];
            updatePreview();
            document.getElementById('formPreviewSection').classList.add('hidden');
            document.getElementById('createFormSection').classList.add('hidden');
            // Return to centered layout
            const formContainer = document.getElementById('formContainer');
            formContainer.className = 'flex justify-center';
            // Reset main form section
            const mainFormSection = document.getElementById('mainFormSection');
            mainFormSection.className = 'w-full max-w-2xl';
        }

        // Fixed CORS issue by using GET request with parameters instead of POST
        async function createGoogleForm() {
            const title = document.getElementById('formTitle').value.trim();
            
            if (!title) {
                alert('Please enter a form title');
                return;
            }
            
            if (questions.length === 0) {
                alert('Please add at least one question');
                return;
            }

            document.getElementById('loadingModal').classList.remove('hidden');
            document.getElementById('loadingModal').classList.add('flex');

            try {
                // Use GET request with URL parameters to avoid CORS issues
                const params = new URLSearchParams({
                    title: title,
                    questions: JSON.stringify(questions)
                });

                const response = await fetch(`${GOOGLE_SCRIPT_URL}?${params.toString()}`, {
                    method: 'GET'
                });

                const result = await response.json();
                
                document.getElementById('loadingModal').classList.add('hidden');
                document.getElementById('loadingModal').classList.remove('flex');

                if (result.success) {
                    document.getElementById('formLink').href = result.formUrl;
                    document.getElementById('successModal').classList.remove('hidden');
                    document.getElementById('successModal').classList.add('flex');
                } else {
                    alert('Failed to create form: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                document.getElementById('loadingModal').classList.add('hidden');
                document.getElementById('loadingModal').classList.remove('flex');
                alert('Network error: ' + error.message);
            }
        }

        // AI Generation Modal Functions
        function showAIGenerationModal() {
            const formTitle = document.getElementById('formTitle').value.trim();
            
            if (!formTitle) {
                alert('Please enter a form title first');
                return;
            }
            
            // Check if there are existing questions
            const hasExistingQuestions = questions.length > 0;
            
            document.getElementById('aiGenerationModal').classList.remove('hidden');
            document.getElementById('aiGenerationModal').classList.add('flex');
            resetAIGenerationModal();
            
            // Update modal title and description if adding to existing questions
            if (hasExistingQuestions) {
                document.querySelector('#aiGenerationModal h2').textContent = 'Add More Questions';
                document.querySelector('#aiGenerationModal p').textContent = `Add ${selectedQuestionCount} more questions to your existing ${questions.length} questions`;
            } else {
                document.querySelector('#aiGenerationModal h2').textContent = 'AI Form Generation';
                document.querySelector('#aiGenerationModal p').textContent = 'Customize your AI-generated form';
            }
        }

        function closeAIGenerationModal() {
            document.getElementById('aiGenerationModal').classList.add('hidden');
            document.getElementById('aiGenerationModal').classList.remove('flex');
            
            // Clear any AI generation flags
            window.aiSemanticResponseCount = null;
            window.isAIGenerationMode = false;
            // Clear selected question types
            if (window.selectedQuestionTypes) {
                window.selectedQuestionTypes = null;
            }
        }

        function resetAIGenerationModal() {
            aiGenerationStep = 1;
            selectedQuestionCount = 5;
            selectedQuestionTypes = ['Short Answer', 'Paragraph', 'Multiple Choice', 'Checkboxes', 'Dropdown'];
            // Store globally for use in response generation
            window.selectedQuestionTypes = selectedQuestionTypes;
            
            // Reset UI
            document.getElementById('customQuestionCount').value = '5';
            document.querySelectorAll('.question-count-btn').forEach(btn => {
                btn.classList.remove('bg-purple-500', 'border-purple-400');
                btn.classList.add('bg-white/10', 'border-white/20');
            });
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            
            showStep(1);
        }

        function selectQuestionCount(count) {
            selectedQuestionCount = count;
            document.getElementById('customQuestionCount').value = count;
            
            // Update button styles
            document.querySelectorAll('.question-count-btn').forEach(btn => {
                btn.classList.remove('bg-purple-500', 'border-purple-400');
                btn.classList.add('bg-white/10', 'border-white/20');
            });
            event.target.classList.remove('bg-white/10', 'border-white/20');
            event.target.classList.add('bg-purple-500', 'border-purple-400');
        }

        function nextStep() {
            if (aiGenerationStep === 1) {
                // Validate question count
                const customCount = parseInt(document.getElementById('customQuestionCount').value);
                if (customCount < 1 || customCount > 20) {
                    alert('Please enter a valid number between 1 and 20');
                    return;
                }
                selectedQuestionCount = customCount;
                showStep(2);
            } else if (aiGenerationStep === 2) {
                // Validate question types
                const checkedTypes = [];
                if (document.getElementById('shortAnswer').checked) checkedTypes.push('Short Answer');
                if (document.getElementById('paragraph').checked) checkedTypes.push('Paragraph');
                if (document.getElementById('multipleChoice').checked) checkedTypes.push('Multiple Choice');
                if (document.getElementById('checkboxes').checked) checkedTypes.push('Checkboxes');
                if (document.getElementById('dropdown').checked) checkedTypes.push('Dropdown');
                
                if (checkedTypes.length === 0) {
                    alert('Please select at least one question type');
                    return;
                }
                selectedQuestionTypes = checkedTypes;
                // Store globally for use in response generation
                window.selectedQuestionTypes = checkedTypes;
                showStep(3);
            } else if (aiGenerationStep === 3) {
                // Validate Semantic responses if enabled
                const generateSemanticData = document.getElementById('generateSemanticData').checked;
                if (generateSemanticData) {
                    const responseCount = parseInt(document.getElementById('SemanticResponseCount').value);
                    const positive = parseInt(document.getElementById('aiPositivePercent').value);
                    const neutral = parseInt(document.getElementById('aiNeutralPercent').value);
                    const negative = parseInt(document.getElementById('aiNegativePercent').value);
                    
                    if (responseCount < 1 || responseCount > 20) {
                        alert('Please enter a valid response count between 1 and 20');
                        return;
                    }
                    
                    if (positive + neutral + negative !== 100) {
                        alert('Sentiment percentages must total 100%');
                        return;
                    }
                }
                updateSummaryStep();
                showStep(4);
            }
        }

        function previousStep() {
            if (aiGenerationStep > 1) {
                showStep(aiGenerationStep - 1);
            }
        }

        function showStep(step) {
            aiGenerationStep = step;
            
            // Hide all steps
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.add('hidden');
            
            // Show current step
            document.getElementById(`step${step}`).classList.remove('hidden');
            
            // Update navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const generateBtn = document.getElementById('generateBtn');
            
            if (step === 1) {
                prevBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');
                generateBtn.classList.add('hidden');
            } else if (step === 2) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
                generateBtn.classList.add('hidden');
            } else if (step === 3) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
                generateBtn.classList.add('hidden');
            } else if (step === 4) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.add('hidden');
                generateBtn.classList.remove('hidden');
            }
        }

        function updateSummaryStep() {
            const formTitle = document.getElementById('formTitle').value.trim();
            document.getElementById('summaryQuestionCount').textContent = selectedQuestionCount;
            document.getElementById('summaryQuestionTypes').textContent = selectedQuestionTypes.join(', ');
            document.getElementById('summaryFormTitle').textContent = formTitle || 'Your Form Title';
            
            // Update Semantic responses summary
            const generateSemanticData = document.getElementById('generateSemanticData').checked;
            const SemanticSummary = document.getElementById('SemanticSummary');
            const SemanticResponseSummary = document.getElementById('SemanticResponseSummary');
            
            if (generateSemanticData) {
                const responseCount = document.getElementById('SemanticResponseCount').value;
                SemanticResponseSummary.textContent = `${responseCount} responses`;
                SemanticSummary.style.display = 'block';
            } else {
                SemanticSummary.style.display = 'none';
            }
        }

        // CSV Questions Import (for options)
        document.getElementById('csvQuestionsFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csv = e.target.result;
                    csvQuestions = parseCSVQuestions(csv);
                    showCSVPreview();
                };
                reader.readAsText(file);
            }
        });

        function parseCSVQuestions(csv) {
            const lines = csv.trim().split('\n');
            return lines.map(line => {
                const columns = line.split(',').map(col => col.trim().replace(/^["']|["']$/g, ''));
                
                if (columns.length === 0 || !columns[0]) return null;
                
                const question = {
                    text: columns[0],
                    type: columns[1] || 'Short Answer',
                    options: []
                };
                
                // Parse options from remaining columns
                if (columns.length > 2) {
                    const optionsString = columns.slice(2).join(',');
                    question.options = optionsString.split(',').map(opt => opt.trim()).filter(opt => opt);
                }
                
                return question;
            }).filter(question => question);
        }

        function showCSVPreview() {
            const preview = document.getElementById('csvPreview');
            const list = document.getElementById('csvQuestionsList');
            
            if (csvQuestions.length > 0) {
                list.innerHTML = csvQuestions.map((q, i) => 
                    `<div class="text-white/90 text-sm mb-1">${i + 1}. ${q}</div>`
                ).join('');
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }

        // CSV Import Functions
        function showCSVImportModal() {
            document.getElementById('csvImportModal').classList.remove('hidden');
            document.getElementById('csvImportModal').classList.add('flex');
            resetCSVImportModal();
        }

        function closeCSVImportModal() {
            document.getElementById('csvImportModal').classList.add('hidden');
            document.getElementById('csvImportModal').classList.remove('flex');
        }

        function resetCSVImportModal() {
            importedQuestions = [];
            document.getElementById('csvImportFile').value = '';
            document.getElementById('csvImportPreview').classList.add('hidden');
            document.getElementById('processCSVBtn').classList.add('hidden');
        }

        // CSV Import File Handler
        document.getElementById('csvImportFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csv = e.target.result;
                    importedQuestions = parseCSVQuestions(csv);
                    showCSVImportPreview();
                };
                reader.readAsText(file);
            }
        });

        // Prevent file input from interfering with modal buttons
        document.getElementById('csvImportModal').addEventListener('click', function(e) {
            // If clicking on buttons or outside the file upload area, don't trigger file input
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                e.stopPropagation();
                return;
            }
        });

        function showCSVImportPreview() {
            const preview = document.getElementById('csvImportPreview');
            const list = document.getElementById('csvImportQuestionsList');
            const count = document.getElementById('csvQuestionCount');
            
            if (importedQuestions.length > 0) {
                list.innerHTML = importedQuestions.map((q, i) => {
                    const optionsText = q.options && q.options.length > 0 ? ` (${q.options.length} options)` : '';
                    return `<div class="text-white/90 text-sm p-2 bg-white/5 rounded-lg">
                        <div class="font-semibold">${i + 1}. ${q.text}</div>
                        <div class="text-xs opacity-75">Type: ${q.type}${optionsText}</div>
                        ${q.options && q.options.length > 0 ? `<div class="text-xs opacity-60 mt-1">Options: ${q.options.join(', ')}</div>` : ''}
                    </div>`;
                }).join('');
                count.textContent = importedQuestions.length;
                preview.classList.remove('hidden');
                document.getElementById('processCSVBtn').classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
                document.getElementById('processCSVBtn').classList.add('hidden');
            }
        }

        function processCSVImport() {
            if (importedQuestions.length === 0) {
                alert('No questions to import');
                return;
            }

            // Add all imported questions with their types and options
            importedQuestions.forEach(question => {
                questions.push({
                    text: question.text,
                    type: question.type,
                    options: question.options || []
                });
            });

            // Show the preview section when questions are imported
            // Change layout to side-by-side
            const formContainer = document.getElementById('formContainer');
            formContainer.className = 'grid grid-cols-1 lg:grid-cols-2 gap-8';
            
            // Adjust main form section to be on the left
            const mainFormSection = document.getElementById('mainFormSection');
            mainFormSection.className = 'w-full';
            
            document.getElementById('formPreviewSection').classList.remove('hidden');
            document.getElementById('createFormSection').classList.remove('hidden');
            
            updatePreview();
            document.getElementById('createFormSection').classList.remove('hidden');
            
            // Show success message
            alert(`Successfully imported ${importedQuestions.length} questions!`);
            
            // Close modal
            closeCSVImportModal();
        }

        function importQuestionsFromCSV() {
            // This function is called from the inline preview
            if (importedQuestions.length === 0) {
                alert('No questions to import');
                return;
            }

            processCSVImport();
        }

        async function generateFormWithAI() {
            const formTitle = document.getElementById('formTitle').value.trim();
            
            if (!formTitle) {
                alert('Please enter a form title first');
                return;
            }

            // Close modal and show loading
            closeAIGenerationModal();
            document.getElementById('loadingModal').classList.remove('hidden');
            document.getElementById('loadingModal').classList.add('flex');

            try {
                // Build prompt based on user selections
                let prompt = `Generate a Google Form for: "${formTitle}"\n\n`;
                prompt += `Create exactly ${selectedQuestionCount} questions with the following types: ${selectedQuestionTypes.join(', ')}\n\n`;
                prompt += `Distribute the questions evenly across the selected types. For choice-based questions (Multiple Choice, Checkboxes, Dropdown), include 3-5 realistic options.\n\n`;
                prompt += `IMPORTANT: Return ONLY valid JSON in this exact format, no additional text:
{
  "title": "Form Title",
  "questions": [
    {
      "text": "Question text here",
      "type": "Short Answer",
      "options": []
    },
    {
      "text": "Question text here", 
      "type": "Multiple Choice",
      "options": ["Option 1", "Option 2", "Option 3"]
    }
  ]
}

For choice-based questions (Multiple Choice, Checkboxes, Dropdown), always include options array.
For text questions (Short Answer, Paragraph), use empty options array: []`;

                const response = await callGeminiAPI(prompt);
                
                // Try to parse the JSON response
                let formData;
                try {
                    formData = JSON.parse(response);
                } catch (parseError) {
                    // Try to extract JSON from the response if it contains extra text
                    const jsonMatch = response.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        try {
                            formData = JSON.parse(jsonMatch[0]);
                        } catch (secondError) {
                            throw parseError; // Use original error
                        }
                    } else {
                        throw parseError;
                    }
                }
                
                try {
                    if (formData.title && formData.questions && Array.isArray(formData.questions)) {
                        const existingQuestionsCount = questions.length;
                        
                        // Add the AI-generated questions (don't clear existing ones)
                        formData.questions.forEach(q => {
                            if (q.text && q.type) {
                                questions.push({
                                    text: q.text,
                                    type: q.type,
                                    options: q.options || []
                                });
                            }
                        });
                        
                        // Update form title if provided and no existing title
                        if (formData.title && !document.getElementById('formTitle').value.trim()) {
                            document.getElementById('formTitle').value = formData.title;
                        }
                        
                        // Show the preview section when AI generates questions
                        // Change layout to side-by-side
                        const formContainer = document.getElementById('formContainer');
                        formContainer.className = 'grid grid-cols-1 lg:grid-cols-2 gap-8';
                        
                        // Adjust main form section to be on the left
                        const mainFormSection = document.getElementById('mainFormSection');
                        mainFormSection.className = 'w-full';
                        
                        document.getElementById('formPreviewSection').classList.remove('hidden');
                        document.getElementById('createFormSection').classList.remove('hidden');
                        
                        updatePreview();
                        document.getElementById('createFormSection').classList.remove('hidden');
                        
                        const newQuestionsCount = questions.length - existingQuestionsCount;
                        if (existingQuestionsCount > 0) {
                            alert(`Successfully added ${newQuestionsCount} more questions! Total: ${questions.length} questions`);
                        } else {
                            alert(`Successfully generated ${questions.length} questions with AI!`);
                        }
                        
                        // Check if Semantic responses were requested
                        const generateSemanticData = document.getElementById('generateSemanticData').checked;
                        if (generateSemanticData) {
                            // Show sentiment configuration popup first
                            document.getElementById('sentimentConfigPopup').classList.remove('hidden');
                            document.getElementById('sentimentConfigPopup').classList.add('flex');
                            
                                        // Store the response count for later use
            window.aiSemanticResponseCount = parseInt(document.getElementById('SemanticResponseCount').value) || 5;
            window.isAIGenerationMode = true; // Flag to track AI generation mode
                        }
                    } else {
                        throw new Error('Invalid response format');
                    }
                } catch (parseError) {
                    console.error('Failed to parse AI response:', response);
                    console.error('Parse error:', parseError);
                    alert('AI generated content, but it wasn\'t in the expected JSON format. The response was:\n\n' + response.substring(0, 200) + '...\n\nPlease try again.');
                }
                
            } catch (error) {
                console.error('AI Form Generation Error:', error);
                alert('Failed to generate form with AI: ' + error.message);
            } finally {
                // Hide loading modal
                document.getElementById('loadingModal').classList.add('hidden');
                document.getElementById('loadingModal').classList.remove('flex');
            }
        }

                 function closeSuccessModal() {
             document.getElementById('successModal').classList.add('hidden');
             document.getElementById('successModal').classList.remove('flex');
             clearForm();
         }

         function closeWelcomeModal() {
             document.getElementById('welcomeModal').classList.add('hidden');
             document.getElementById('welcomeModal').classList.remove('flex');
         }

         function showTutorial() {
             // Show a simple tutorial alert for now
             alert('🎯 How to use Form Builder Pro:\n\n1. Enter your form title\n2. Click "Generate Questions with AI" to create questions automatically\n3. Review and edit the generated questions if needed\n4. Click "Create Google Form" to generate your form\n\n✨ New Features:\n• Drag & drop to reorder questions\n• Shuffle questions randomly\n• Generate Semantic test responses\n• Download responses as CSV/JSON\n\nThat\'s it! No manual question creation needed!');
         }

        setOptionMethod('manual');
        
        // Particle Effect
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 20;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 30 + 's';
                particle.style.animationDuration = (Math.random() * 15 + 20) + 's';
                particle.style.opacity = Math.random() * 0.3 + 0.05;
                particlesContainer.appendChild(particle);
            }
        }
        
                 // Initialize particles when page loads
         document.addEventListener('DOMContentLoaded', function() {
             createParticles();
             
             // Show welcome modal on first visit
             const hasVisited = localStorage.getItem('formBuilderVisited');
             if (!hasVisited) {
                 document.getElementById('welcomeModal').classList.remove('hidden');
                 document.getElementById('welcomeModal').classList.add('flex');
                 localStorage.setItem('formBuilderVisited', 'true');
             }
             
             // Mobile optimizations
             if (window.innerWidth <= 768) {
                 // Reduce particle count on mobile for better performance
                 const particles = document.querySelectorAll('.particle');
                 particles.forEach((particle, index) => {
                     if (index > 10) particle.remove();
                 });
                 
                 // Add touch-friendly interactions
                 document.querySelectorAll('button').forEach(button => {
                     button.addEventListener('touchstart', function() {
                         this.style.transform = 'scale(0.95)';
                     });
                     button.addEventListener('touchend', function() {
                         this.style.transform = '';
                     });
                 });
             }
         });

        // Initialize drag and drop functionality
        function initDragAndDrop() {
            const previewContainer = document.getElementById('questionsPreview');
            
            previewContainer.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('question-item')) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', e.target.outerHTML);
                }
            });

            previewContainer.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('question-item')) {
                    e.target.classList.remove('dragging');
                }
            });

            previewContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const draggingElement = document.querySelector('.dragging');
                if (!draggingElement) return;

                const afterElement = getDragAfterElement(previewContainer, e.clientY);
                if (afterElement) {
                    previewContainer.insertBefore(draggingElement, afterElement);
                } else {
                    previewContainer.appendChild(draggingElement);
                }
            });

            previewContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                updateQuestionNumbers();
            });
        }

        // Helper function to determine drop position
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.question-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Update question numbers after drag and drop
        function updateQuestionNumbers() {
            const questionElements = document.querySelectorAll('.question-item');
            questionElements.forEach((element, index) => {
                const numberElement = element.querySelector('.question-number');
                if (numberElement) {
                    numberElement.textContent = index + 1;
                }
            });
        }

        // Shuffle questions function
        function shuffleQuestions() {
            if (questions.length < 2) {
                Swal.fire('Info', 'Need at least 2 questions to reorder', 'info');
                return;
            }

          
            for (let i = questions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [questions[i], questions[j]] = [questions[j], questions[i]];
            }

            updatePreview();
            Swal.fire('Success!', 'Questions reorderd successfully', 'success');
        }

        // Generate Semantic responses function
        function generateSemanticResponses() {
            if (questions.length === 0) {
                Swal.fire('No Questions', 'Please add some questions to your form before generating Semantic responses.', 'warning');
                return;
            }
            
            // Show sentiment configuration popup first
            document.getElementById('sentimentConfigPopup').classList.remove('hidden');
            document.getElementById('sentimentConfigPopup').classList.add('flex');
        }

        // Hide sentiment modal
        function hideSentimentModal() {
            document.getElementById('sentimentModal').classList.add('hidden');
            document.getElementById('sentimentModal').classList.remove('flex');
        }

        // Use default sentiment configuration
        function useDefaultSentiment() {
            hideSentimentConfigPopup();
            
            // Check if this is from AI generation or standalone
            if (window.isAIGenerationMode) {
                // AI generation case - generate responses directly with default values
                const responseCount = window.aiSemanticResponseCount;
                const responses = generateResponsesLocally(questions, responseCount, { positive: 70, neutral: 20, negative: 10 });
                showResponsesResults(responses);
                window.aiSemanticResponseCount = null; // Clear the flag
                window.isAIGenerationMode = false; // Clear the flag
            } else {
                // Standalone case - show sentiment modal
                document.getElementById('sentimentModal').classList.remove('hidden');
                document.getElementById('sentimentModal').classList.add('flex');
                resetSentimentSliders();
            }
        }

        // Use manual sentiment configuration
        function useManualSentiment() {
            hideSentimentConfigPopup();
            
            // Check if this is from AI generation or standalone
            if (window.isAIGenerationMode) {
                // AI generation case - show sentiment modal
                document.getElementById('sentimentModal').classList.remove('hidden');
                document.getElementById('sentimentModal').classList.add('flex');
                resetSentimentSliders();
            } else {
                // Standalone case - show sentiment modal
                document.getElementById('sentimentModal').classList.remove('hidden');
                document.getElementById('sentimentModal').classList.add('flex');
                resetSentimentSliders();
            }
        }

        // Hide sentiment configuration popup
        function hideSentimentConfigPopup() {
            document.getElementById('sentimentConfigPopup').classList.add('hidden');
            document.getElementById('sentimentConfigPopup').classList.remove('flex');
        }

        // Reset sentiment sliders
        function resetSentimentSliders() {
            document.getElementById('positivePercent').value = 70;
            document.getElementById('neutralPercent').value = 20;
            document.getElementById('negativePercent').value = 10;
            updateSentimentDisplay();
        }

        // Update sentiment sliders
        function updateSentimentSliders(changedType, value) {
            const positive = parseInt(document.getElementById('positivePercent').value);
            const neutral = parseInt(document.getElementById('neutralPercent').value);
            const negative = parseInt(document.getElementById('negativePercent').value);
            
            let total = positive + neutral + negative;
            
            // Adjust other sliders to maintain 100% total
            if (changedType === 'positive') {
                const remaining = 100 - value;
                if (remaining >= 0) {
                    const neutralRatio = neutral / (neutral + negative);
                    const negativeRatio = negative / (neutral + negative);
                    document.getElementById('neutralPercent').value = Math.round(remaining * neutralRatio);
                    document.getElementById('negativePercent').value = Math.round(remaining * negativeRatio);
                }
            } else if (changedType === 'neutral') {
                const remaining = 100 - value;
                if (remaining >= 0) {
                    const positiveRatio = positive / (positive + negative);
                    const negativeRatio = negative / (positive + negative);
                    document.getElementById('positivePercent').value = Math.round(remaining * positiveRatio);
                    document.getElementById('negativePercent').value = Math.round(remaining * negativeRatio);
                }
            } else if (changedType === 'negative') {
                const remaining = 100 - value;
                if (remaining >= 0) {
                    const positiveRatio = positive / (positive + neutral);
                    const neutralRatio = neutral / (positive + neutral);
                    document.getElementById('positivePercent').value = Math.round(remaining * positiveRatio);
                    document.getElementById('neutralPercent').value = Math.round(remaining * neutralRatio);
                }
            }
            
            updateSentimentDisplay();
        }

        // Update sentiment display
        function updateSentimentDisplay() {
            const positive = document.getElementById('positivePercent').value;
            const neutral = document.getElementById('neutralPercent').value;
            const negative = document.getElementById('negativePercent').value;
            const total = parseInt(positive) + parseInt(neutral) + parseInt(negative);
            
            document.getElementById('positiveValue').textContent = positive + '%';
            document.getElementById('neutralValue').textContent = neutral + '%';
            document.getElementById('negativeValue').textContent = negative + '%';
            document.getElementById('totalPercent').textContent = total + '%';
        }

        // Update AI Generation Modal sentiment sliders
        function updateAISentimentSliders(changedType, value) {
            const positive = parseInt(document.getElementById('aiPositivePercent').value);
            const neutral = parseInt(document.getElementById('aiNeutralPercent').value);
            const negative = parseInt(document.getElementById('aiNegativePercent').value);
            
            let total = positive + neutral + negative;
            
            // Adjust other sliders to maintain 100% total
            if (changedType === 'positive') {
                const remaining = 100 - value;
                if (remaining >= 0) {
                    const neutralRatio = neutral / (neutral + negative);
                    const negativeRatio = negative / (neutral + negative);
                    document.getElementById('aiNeutralPercent').value = Math.round(remaining * neutralRatio);
                    document.getElementById('aiNegativePercent').value = Math.round(remaining * negativeRatio);
                }
            } else if (changedType === 'neutral') {
                const remaining = 100 - value;
                if (remaining >= 0) {
                    const positiveRatio = positive / (positive + negative);
                    const negativeRatio = negative / (positive + negative);
                    document.getElementById('aiPositivePercent').value = Math.round(remaining * positiveRatio);
                    document.getElementById('aiNegativePercent').value = Math.round(remaining * negativeRatio);
                }
            } else if (changedType === 'negative') {
                const remaining = 100 - value;
                if (remaining >= 0) {
                    const positiveRatio = positive / (positive + neutral);
                    const neutralRatio = neutral / (positive + neutral);
                    document.getElementById('aiPositivePercent').value = Math.round(remaining * positiveRatio);
                    document.getElementById('aiNeutralPercent').value = Math.round(remaining * neutralRatio);
                }
            }
            
            updateAISentimentDisplay();
        }

        // Update AI Generation Modal sentiment display
        function updateAISentimentDisplay() {
            const positive = document.getElementById('aiPositivePercent').value;
            const neutral = document.getElementById('aiNeutralPercent').value;
            const negative = document.getElementById('aiNegativePercent').value;
            const total = parseInt(positive) + parseInt(neutral) + parseInt(negative);
            
            document.getElementById('aiPositiveValue').textContent = positive + '%';
            document.getElementById('aiNeutralValue').textContent = neutral + '%';
            document.getElementById('aiNegativeValue').textContent = negative + '%';
            document.getElementById('aiTotalPercent').textContent = total + '%';
        }

        // Testv5responses with sentiment
        function generateResponsesWithSentiment() {
            const positive = parseInt(document.getElementById('positivePercent').value);
            const neutral = parseInt(document.getElementById('neutralPercent').value);
            const negative = parseInt(document.getElementById('negativePercent').value);
            
            // Use the question types selected during AI generation, or fall back to dropdown
            let questionTypeFilter = '';
            if (window.selectedQuestionTypes && window.selectedQuestionTypes.length > 0) {
                // If specific question types were selected during AI generation, use those
                questionTypeFilter = window.selectedQuestionTypes;
            } else {
                // Fall back to dropdown selection for standalone generation
                questionTypeFilter = document.getElementById('questionTypeFilter').value;
            }
            
            if (positive + neutral + negative !== 100) {
                Swal.fire('Invalid Configuration', 'Sentiment percentages must total 100%.', 'error');
                return;
            }

            // Check if this is from AI generation or standalone
            const numResponses = window.aiSemanticResponseCount || 5;
            const responses = generateResponsesLocally(questions, numResponses, { positive, neutral, negative }, questionTypeFilter);
            
            if (responses.length === 0) {
                return; // Error already shown by generateResponsesLocally
            }
            
            hideSentimentModal();
            showResponsesResults(responses);
            
            // Clear the AI flags if they were set
            if (window.aiSemanticResponseCount) {
                window.aiSemanticResponseCount = null;
            }
            if (window.isAIGenerationMode) {
                window.isAIGenerationMode = false;
            }
        }

        // Generate responses locally
        function generateResponsesLocally(formQuestions, numResponses, sentimentConfig, questionTypeFilter = null) {
            const responses = [];
            const { positive, neutral, negative } = sentimentConfig;
            
            // Filter questions by type if specified
            let filteredQuestions;
            if (questionTypeFilter) {
                if (Array.isArray(questionTypeFilter)) {
                    // If it's an array of question types (from AI generation)
                    filteredQuestions = formQuestions.filter(q => questionTypeFilter.includes(q.type));
                } else {
                    // If it's a single question type (from dropdown)
                    filteredQuestions = formQuestions.filter(q => q.type === questionTypeFilter);
                }
            } else {
                filteredQuestions = formQuestions;
            }
            
            if (filteredQuestions.length === 0) {
                const filterText = Array.isArray(questionTypeFilter) ? questionTypeFilter.join(', ') : questionTypeFilter;
                Swal.fire('No Questions Found', `No questions of type "${filterText}" found in your form.`, 'warning');
                return [];
            }
            
            for (let i = 0; i < numResponses; i++) {
                const response = {};
                const sentiment = getRandomSentiment(positive, neutral, negative);
                
                // Only generate responses for filtered questions
                filteredQuestions.forEach((question, index) => {
                    const originalIndex = formQuestions.indexOf(question);
                    response[`Question ${originalIndex + 1}`] = generateLocalResponse(question, sentiment);
                });
                
                responses.push(response);
            }
            
            return responses;
        }

        // Get random sentiment
        function getRandomSentiment(positive, neutral, negative) {
            const rand = Math.random() * 100;
            if (rand < positive) return 'positive';
            if (rand < positive + neutral) return 'neutral';
            return 'negative';
        }

        // Generate local response
        function generateLocalResponse(question, sentiment) {
            const { type, options, text } = question;
            
            switch (type) {
                case 'Short Answer':
                    // Generate 1-2 lines for short answers
                    const shortAnswers = {
                        positive: [
                            'Excellent experience overall!',
                            'Very satisfied with the service.',
                            'Great quality and fast delivery.',
                            'Highly recommend this product.',
                            'Outstanding customer service.'
                        ],
                        neutral: [
                            'It was okay, nothing special.',
                            'Average experience, meets expectations.',
                            'Decent quality for the price.',
                            'Satisfactory service delivery.',
                            'Standard experience as expected.'
                        ],
                        negative: [
                            'Poor quality, very disappointed.',
                            'Not worth the money spent.',
                            'Terrible customer service experience.',
                            'Would not recommend to others.',
                            'Below average performance.'
                        ]
                    };
                    return shortAnswers[sentiment][Math.floor(Math.random() * shortAnswers[sentiment].length)];
                    
                case 'Paragraph':
                    // Generate at least 5 lines for paragraph answers
                    const paragraphAnswers = {
                        positive: [
                            'I had an absolutely wonderful experience with this service. The quality exceeded my expectations in every way possible. The staff was incredibly professional and attentive to all my needs. The turnaround time was much faster than I anticipated, and the final result was simply outstanding. I would definitely recommend this to anyone looking for similar services. The attention to detail was remarkable, and I felt valued as a customer throughout the entire process.',
                            'This has been one of the best experiences I\'ve had in a long time. The level of professionalism displayed by the team was exceptional. Every aspect of the service was handled with care and precision. The communication was clear and timely, making the entire process smooth and enjoyable. I was particularly impressed by how they went above and beyond to ensure my satisfaction. The results speak for themselves - absolutely fantastic work that I\'m very happy with.',
                            'I cannot express enough how satisfied I am with this experience. The service quality was top-notch from start to finish. The team demonstrated excellent expertise and knowledge in their field. What really stood out was their commitment to customer satisfaction and attention to detail. The process was seamless and the outcome exceeded all my expectations. I would highly recommend this service to anyone who values quality and professionalism.'
                        ],
                        neutral: [
                            'My experience was generally satisfactory and met most of my expectations. The service was delivered within the promised timeframe, though not particularly exceptional. The quality was acceptable for the price point, though there were some areas that could have been better. The staff was polite and professional, though not overly enthusiastic. Overall, it was a decent experience that I would consider again if needed, but I wouldn\'t go out of my way to recommend it.',
                            'The service was adequate and fulfilled the basic requirements I had. There were both positive and negative aspects to consider. On the positive side, the delivery was on time and the staff was reasonably helpful. However, there were some minor issues with quality that could have been addressed better. The experience was neither particularly memorable nor disappointing - it was simply functional. I would use this service again if the price was right.',
                            'This was a fairly standard experience that didn\'t particularly stand out in any way. The service was delivered as promised, though not with any extra effort or attention to detail. The quality was acceptable but not exceptional, and the staff was professional but not overly engaging. The process was straightforward and completed without major issues. While I wouldn\'t hesitate to use this service again, I also wouldn\'t go out of my way to recommend it to others.'
                        ],
                        negative: [
                            'I was extremely disappointed with the overall experience and quality of service provided. The staff seemed disinterested and unprofessional throughout the entire process. There were numerous delays and communication issues that made the experience frustrating. The final result was far below my expectations and the quality was subpar for the price paid. I would not recommend this service to anyone and would actively discourage others from using it. The lack of attention to detail was concerning.',
                            'This was one of the worst experiences I\'ve had with a service provider. The quality was poor and the customer service was even worse. There were multiple issues that were not addressed properly, and the staff was unhelpful when I tried to resolve problems. The delivery was late and the final product was not what was promised. I felt like my concerns were completely ignored throughout the process. I would never use this service again.',
                            'I am very dissatisfied with the service I received. The quality was below average and the staff was unprofessional and unresponsive to my needs. There were several problems that were not resolved satisfactorily, and the overall experience was frustrating and disappointing. The final result did not meet my expectations at all, and I felt like my time and money were wasted. I would not recommend this service to anyone.'
                        ]
                    };
                    return paragraphAnswers[sentiment][Math.floor(Math.random() * paragraphAnswers[sentiment].length)];
                    
                case 'Multiple Choice':
                case 'Dropdown':
                case 'Checkboxes':
                    return options && options.length > 0 ? options[Math.floor(Math.random() * options.length)] : 'Option 1';
                default:
                    return 'Response';
            }
        }

        // Show responses results
        function showResponsesResults(responses) {
            const downloadSection = document.getElementById('responsesDownloadSection');
            const previewTable = document.getElementById('responsesPreviewTable');
            downloadSection.innerHTML = '';
            
            // Create preview table
            if (questions.length > 0 && responses.length > 0) {
                const tableHTML = createResponsesPreviewTable(responses);
                previewTable.innerHTML = tableHTML;
            }
            
            // Create CSV download button
            const csvButton = document.createElement('button');
            csvButton.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-xl transition-all flex items-center justify-center mb-3';
            csvButton.innerHTML = '<i class="fas fa-download mr-2"></i>Download Responses (CSV)';
            csvButton.onclick = () => downloadResponsesCSV(responses);
            
            // Create JSON download button
            const jsonButton = document.createElement('button');
            jsonButton.className = 'w-full bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-xl transition-all flex items-center justify-center';
            jsonButton.innerHTML = '<i class="fas fa-code mr-2"></i>Download Responses (JSON)';
            jsonButton.onclick = () => downloadResponsesJSON(responses);
            
            downloadSection.appendChild(csvButton);
            downloadSection.appendChild(jsonButton);
            
            document.getElementById('responsesResults').classList.remove('hidden');
            document.getElementById('responsesResults').classList.add('flex');
        }

        // Create responses preview table
        function createResponsesPreviewTable(responses) {
            if (questions.length === 0 || responses.length === 0) {
                return '<p class="text-white/60 text-center py-4">No responses to preview</p>';
            }

            // Get the question type filter to show only relevant questions
            let filteredQuestions;
            if (window.selectedQuestionTypes && window.selectedQuestionTypes.length > 0) {
                // Use question types selected during AI generation
                filteredQuestions = questions.filter(q => window.selectedQuestionTypes.includes(q.type));
            } else {
                // Fall back to dropdown selection
                const questionTypeFilter = document.getElementById('questionTypeFilter')?.value || '';
                filteredQuestions = questionTypeFilter 
                    ? questions.filter(q => q.type === questionTypeFilter)
                    : questions;
            }

            let tableHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-white/20">
                                <th class="text-left text-white font-semibold p-2">Response #</th>
            `;
            
            // Add question headers with type and text (only filtered questions)
            filteredQuestions.forEach((question, index) => {
                const questionText = question.text.length > 25 ? question.text.substring(0, 25) + '...' : question.text;
                const questionType = question.type || 'Text';
                tableHTML += `<th class="text-left text-white font-semibold p-2">${questionType}: ${questionText}</th>`;
            });
            
            tableHTML += '</tr></thead><tbody>';
            
            // Add response rows
            responses.forEach((response, responseIndex) => {
                tableHTML += `<tr class="border-b border-white/10">`;
                tableHTML += `<td class="text-white/80 font-medium p-2">${responseIndex + 1}</td>`;
                
                filteredQuestions.forEach((question, questionIndex) => {
                    // The response data uses "Question X" format as keys
                    const originalIndex = questions.indexOf(question);
                    const questionKey = `Question ${originalIndex + 1}`;
                    const answer = response[questionKey] || 'No response';
                    
                    tableHTML += `<td class="text-white/70 p-2">${answer}</td>`;
                });
                
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table></div>';
            
            return tableHTML;
        }

        // Hide responses results
        function hideResponsesResults() {
            document.getElementById('responsesResults').classList.add('hidden');
            document.getElementById('responsesResults').classList.remove('flex');
        }

        // Download responses as CSV
        function downloadResponsesCSV(responses) {
            const formTitle = document.getElementById('formTitle').value.trim() || 'AI-Generated Form';
            
            // Get the question type filter to include only relevant questions
            let filteredQuestions;
            if (window.selectedQuestionTypes && window.selectedQuestionTypes.length > 0) {
                // Use question types selected during AI generation
                filteredQuestions = questions.filter(q => window.selectedQuestionTypes.includes(q.type));
            } else {
                // Fall back to dropdown selection
                const questionTypeFilter = document.getElementById('questionTypeFilter')?.value || '';
                filteredQuestions = questionTypeFilter 
                    ? questions.filter(q => q.type === questionTypeFilter)
                    : questions;
            }
            
            // Create descriptive headers with question text and type
            const headers = ['Response #'];
            filteredQuestions.forEach((q, i) => {
                const questionText = q.text.length > 50 ? q.text.substring(0, 50) + '...' : q.text;
                const questionType = q.type || 'Text';
                headers.push(`${questionType} - ${questionText}`);
            });
            
            const csvContent = [
                headers.join(','),
                ...responses.map((response, index) => {
                    const row = [index + 1];
                    filteredQuestions.forEach((q, i) => {
                        const originalIndex = questions.indexOf(q);
                        const answer = response[`Question ${originalIndex + 1}`] || '';
                        row.push(`"${answer.replace(/"/g, '""')}"`);
                    });
                    return row.join(',');
                })
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${formTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_synthetic_responses.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Download responses as JSON
        function downloadResponsesJSON(responses) {
            const formTitle = document.getElementById('formTitle').value.trim() || 'AI-Generated Form';
            
            // Get the question type filter to include only relevant questions
            let filteredQuestions;
            let questionTypeFilterText;
            if (window.selectedQuestionTypes && window.selectedQuestionTypes.length > 0) {
                // Use question types selected during AI generation
                filteredQuestions = questions.filter(q => window.selectedQuestionTypes.includes(q.type));
                questionTypeFilterText = window.selectedQuestionTypes.join(', ');
            } else {
                // Fall back to dropdown selection
                const questionTypeFilter = document.getElementById('questionTypeFilter')?.value || '';
                filteredQuestions = questionTypeFilter 
                    ? questions.filter(q => q.type === questionTypeFilter)
                    : questions;
                questionTypeFilterText = questionTypeFilter || "All Question Types";
            }
            
            // Create responses with descriptive field names
            const descriptiveResponses = responses.map((response, responseIndex) => {
                const descriptiveResponse = {
                    responseNumber: responseIndex + 1,
                    timestamp: new Date().toISOString()
                };
                
                filteredQuestions.forEach((question, questionIndex) => {
                    const originalIndex = questions.indexOf(question);
                    const questionKey = `Question ${originalIndex + 1}`;
                    const answer = response[questionKey] || '';
                    
                    // Create descriptive field name
                    const questionText = question.text.length > 50 ? question.text.substring(0, 50) + '...' : question.text;
                    const questionType = question.type || 'Text';
                    const fieldName = `${questionType}_${questionText.replace(/[^a-z0-9]/gi, '_')}`;
                    
                    descriptiveResponse[fieldName] = answer;
                });
                
                return descriptiveResponse;
            });
            
            const data = {
                formTitle: formTitle,
                formDescription: "AI-Generated Form with Synthetic Responses",
                questions: filteredQuestions.map((q, i) => ({
                    questionNumber: i + 1,
                    questionType: q.type || 'Text',
                    questionText: q.text,
                    options: q.options || []
                })),
                responses: descriptiveResponses,
                generatedAt: new Date().toISOString(),
                totalResponses: responses.length,
                metadata: {
                    generationMethod: "Synthetic Response Generation",
                    sentimentDistribution: "Customized based on user settings",
                    dataFormat: "Structured JSON with descriptive field names",
                    questionTypeFilter: questionTypeFilterText
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${formTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_synthetic_responses.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Add event listeners for new features
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize drag and drop
            initDragAndDrop();
            
            // Sentiment modal controls
            document.getElementById('closeSentimentModal').addEventListener('click', hideSentimentModal);
            document.getElementById('cancelSentimentModal').addEventListener('click', hideSentimentModal);
            document.getElementById('generateSemanticResponses').addEventListener('click', generateResponsesWithSentiment);
            document.getElementById('closeResponsesResults').addEventListener('click', hideResponsesResults);
            
            // Sentiment slider controls
            document.getElementById('positivePercent').addEventListener('input', (e) => {
                updateSentimentSliders('positive', e.target.value);
            });
            document.getElementById('neutralPercent').addEventListener('input', (e) => {
                updateSentimentSliders('neutral', e.target.value);
            });
            document.getElementById('negativePercent').addEventListener('input', (e) => {
                updateSentimentSliders('negative', e.target.value);
            });
            
            // AI Generation Modal Semantic responses controls
            document.getElementById('generateSemanticData').addEventListener('change', function() {
                const SemanticOptions = document.getElementById('SemanticOptions');
                if (this.checked) {
                    SemanticOptions.classList.remove('hidden');
                } else {
                    SemanticOptions.classList.add('hidden');
                }
            });
            
            // AI Generation Modal sentiment slider controls
            document.getElementById('aiPositivePercent').addEventListener('input', (e) => {
                updateAISentimentSliders('positive', e.target.value);
            });
            document.getElementById('aiNeutralPercent').addEventListener('input', (e) => {
                updateAISentimentSliders('neutral', e.target.value);
            });
            document.getElementById('aiNegativePercent').addEventListener('input', (e) => {
                updateAISentimentSliders('negative', e.target.value);
            });
            
            // Fix close button for responses results modal
            document.addEventListener('click', function(e) {
                if (e.target.id === 'closeResponsesResults' || e.target.closest('#closeResponsesResults')) {
                    hideResponsesResults();
                }
            });
        });
    </script>
</body>
</html>